/**
 * Mozilla Public License, version 2.0
 *
 * 1. Definitions
 *
 * 1.1. “Contributor”
 *
 *      means each individual or legal entity that creates, contributes to the
 *      creation of, or owns Covered Software.
 *
 * 1.2. “Contributor Version”
 *
 *      means the combination of the Contributions of others (if any) used by a
 *      Contributor and that particular Contributor’s Contribution.
 *
 * 1.3. “Contribution”
 *
 *      means Covered Software of a particular Contributor.
 *
 * 1.4. “Covered Software”
 *
 *      means Source Code Form to which the initial Contributor has attached the
 *      notice in Exhibit A, the Executable Form of such Source Code Form, and
 *      Modifications of such Source Code Form, in each case including portions
 *      thereof.
 *
 * 1.5. “Incompatible With Secondary Licenses”
 *      means
 *
 *      a. that the initial Contributor has attached the notice described in
 *         Exhibit B to the Covered Software; or
 *
 *      b. that the Covered Software was made available under the terms of version
 *         1.1 or earlier of the License, but not also under the terms of a
 *         Secondary License.
 *
 * 1.6. “Executable Form”
 *
 *      means any form of the work other than Source Code Form.
 *
 * 1.7. “Larger Work”
 *
 *      means a work that combines Covered Software with other material, in a separate
 *      file or files, that is not Covered Software.
 *
 * 1.8. “License”
 *
 *      means this document.
 *
 * 1.9. “Licensable”
 *
 *      means having the right to grant, to the maximum extent possible, whether at the
 *      time of the initial grant or subsequently, any and all of the rights conveyed by
 *      this License.
 *
 * 1.10. “Modifications”
 *
 *      means any of the following:
 *
 *      a. any file in Source Code Form that results from an addition to, deletion
 *         from, or modification of the contents of Covered Software; or
 *
 *      b. any new file in Source Code Form that contains any Covered Software.
 *
 * 1.11. “Patent Claims” of a Contributor
 *
 *       means any patent claim(s), including without limitation, method, process,
 *       and apparatus claims, in any patent Licensable by such Contributor that
 *       would be infringed, but for the grant of the License, by the making,
 *       using, selling, offering for sale, having made, import, or transfer of
 *       either its Contributions or its Contributor Version.
 *
 * 1.12. “Secondary License”
 *
 *       means either the GNU General Public License, Version 2.0, the GNU Lesser
 *       General Public License, Version 2.1, the GNU Affero General Public
 *       License, Version 3.0, or any later versions of those licenses.
 *
 * 1.13. “Source Code Form”
 *
 *       means the form of the work preferred for making modifications.
 *
 * 1.14. “You” (or “Your”)
 *
 *       means an individual or a legal entity exercising rights under this
 *       License. For legal entities, “You” includes any entity that controls, is
 *       controlled by, or is under common control with You. For purposes of this
 *       definition, “control” means (a) the power, direct or indirect, to cause
 *       the direction or management of such entity, whether by contract or
 *       otherwise, or (b) ownership of more than fifty percent (50%) of the
 *       outstanding shares or beneficial ownership of such entity.
 *
 *
 * 2. License Grants and Conditions
 *
 * 2.1. Grants
 *
 *      Each Contributor hereby grants You a world-wide, royalty-free,
 *      non-exclusive license:
 *
 *      a. under intellectual property rights (other than patent or trademark)
 *         Licensable by such Contributor to use, reproduce, make available,
 *         modify, display, perform, distribute, and otherwise exploit its
 *         Contributions, either on an unmodified basis, with Modifications, or as
 *         part of a Larger Work; and
 *
 *      b. under Patent Claims of such Contributor to make, use, sell, offer for
 *         sale, have made, import, and otherwise transfer either its Contributions
 *         or its Contributor Version.
 *
 * 2.2. Effective Date
 *
 *      The licenses granted in Section 2.1 with respect to any Contribution become
 *      effective for each Contribution on the date the Contributor first distributes
 *      such Contribution.
 *
 * 2.3. Limitations on Grant Scope
 *
 *      The licenses granted in this Section 2 are the only rights granted under this
 *      License. No additional rights or licenses will be implied from the distribution
 *      or licensing of Covered Software under this License. Notwithstanding Section
 *      2.1(b) above, no patent license is granted by a Contributor:
 *
 *      a. for any code that a Contributor has removed from Covered Software; or
 *
 *      b. for infringements caused by: (i) Your and any other third party’s
 *         modifications of Covered Software, or (ii) the combination of its
 *         Contributions with other software (except as part of its Contributor
 *         Version); or
 *
 *      c. under Patent Claims infringed by Covered Software in the absence of its
 *         Contributions.
 *
 *      This License does not grant any rights in the trademarks, service marks, or
 *      logos of any Contributor (except as may be necessary to comply with the
 *      notice requirements in Section 3.4).
 *
 * 2.4. Subsequent Licenses
 *
 *      No Contributor makes additional grants as a result of Your choice to
 *      distribute the Covered Software under a subsequent version of this License
 *      (see Section 10.2) or under the terms of a Secondary License (if permitted
 *      under the terms of Section 3.3).
 *
 * 2.5. Representation
 *
 *      Each Contributor represents that the Contributor believes its Contributions
 *      are its original creation(s) or it has sufficient rights to grant the
 *      rights to its Contributions conveyed by this License.
 *
 * 2.6. Fair Use
 *
 *      This License is not intended to limit any rights You have under applicable
 *      copyright doctrines of fair use, fair dealing, or other equivalents.
 *
 * 2.7. Conditions
 *
 *      Sections 3.1, 3.2, 3.3, and 3.4 are conditions of the licenses granted in
 *      Section 2.1.
 *
 *
 * 3. Responsibilities
 *
 * 3.1. Distribution of Source Form
 *
 *      All distribution of Covered Software in Source Code Form, including any
 *      Modifications that You create or to which You contribute, must be under the
 *      terms of this License. You must inform recipients that the Source Code Form
 *      of the Covered Software is governed by the terms of this License, and how
 *      they can obtain a copy of this License. You may not attempt to alter or
 *      restrict the recipients’ rights in the Source Code Form.
 *
 * 3.2. Distribution of Executable Form
 *
 *      If You distribute Covered Software in Executable Form then:
 *
 *      a. such Covered Software must also be made available in Source Code Form,
 *         as described in Section 3.1, and You must inform recipients of the
 *         Executable Form how they can obtain a copy of such Source Code Form by
 *         reasonable means in a timely manner, at a charge no more than the cost
 *         of distribution to the recipient; and
 *
 *      b. You may distribute such Executable Form under the terms of this License,
 *         or sublicense it under different terms, provided that the license for
 *         the Executable Form does not attempt to limit or alter the recipients’
 *         rights in the Source Code Form under this License.
 *
 * 3.3. Distribution of a Larger Work
 *
 *      You may create and distribute a Larger Work under terms of Your choice,
 *      provided that You also comply with the requirements of this License for the
 *      Covered Software. If the Larger Work is a combination of Covered Software
 *      with a work governed by one or more Secondary Licenses, and the Covered
 *      Software is not Incompatible With Secondary Licenses, this License permits
 *      You to additionally distribute such Covered Software under the terms of
 *      such Secondary License(s), so that the recipient of the Larger Work may, at
 *      their option, further distribute the Covered Software under the terms of
 *      either this License or such Secondary License(s).
 *
 * 3.4. Notices
 *
 *      You may not remove or alter the substance of any license notices (including
 *      copyright notices, patent notices, disclaimers of warranty, or limitations
 *      of liability) contained within the Source Code Form of the Covered
 *      Software, except that You may alter any license notices to the extent
 *      required to remedy known factual inaccuracies.
 *
 * 3.5. Application of Additional Terms
 *
 *      You may choose to offer, and to charge a fee for, warranty, support,
 *      indemnity or liability obligations to one or more recipients of Covered
 *      Software. However, You may do so only on Your own behalf, and not on behalf
 *      of any Contributor. You must make it absolutely clear that any such
 *      warranty, support, indemnity, or liability obligation is offered by You
 *      alone, and You hereby agree to indemnify every Contributor for any
 *      liability incurred by such Contributor as a result of warranty, support,
 *      indemnity or liability terms You offer. You may include additional
 *      disclaimers of warranty and limitations of liability specific to any
 *      jurisdiction.
 *
 * 4. Inability to Comply Due to Statute or Regulation
 *
 *    If it is impossible for You to comply with any of the terms of this License
 *    with respect to some or all of the Covered Software due to statute, judicial
 *    order, or regulation then You must: (a) comply with the terms of this License
 *    to the maximum extent possible; and (b) describe the limitations and the code
 *    they affect. Such description must be placed in a text file included with all
 *    distributions of the Covered Software under this License. Except to the
 *    extent prohibited by statute or regulation, such description must be
 *    sufficiently detailed for a recipient of ordinary skill to be able to
 *    understand it.
 *
 * 5. Termination
 *
 * 5.1. The rights granted under this License will terminate automatically if You
 *      fail to comply with any of its terms. However, if You become compliant,
 *      then the rights granted under this License from a particular Contributor
 *      are reinstated (a) provisionally, unless and until such Contributor
 *      explicitly and finally terminates Your grants, and (b) on an ongoing basis,
 *      if such Contributor fails to notify You of the non-compliance by some
 *      reasonable means prior to 60 days after You have come back into compliance.
 *      Moreover, Your grants from a particular Contributor are reinstated on an
 *      ongoing basis if such Contributor notifies You of the non-compliance by
 *      some reasonable means, this is the first time You have received notice of
 *      non-compliance with this License from such Contributor, and You become
 *      compliant prior to 30 days after Your receipt of the notice.
 *
 * 5.2. If You initiate litigation against any entity by asserting a patent
 *      infringement claim (excluding declaratory judgment actions, counter-claims,
 *      and cross-claims) alleging that a Contributor Version directly or
 *      indirectly infringes any patent, then the rights granted to You by any and
 *      all Contributors for the Covered Software under Section 2.1 of this License
 *      shall terminate.
 *
 * 5.3. In the event of termination under Sections 5.1 or 5.2 above, all end user
 *      license agreements (excluding distributors and resellers) which have been
 *      validly granted by You or Your distributors under this License prior to
 *      termination shall survive termination.
 *
 * 6. Disclaimer of Warranty
 *
 *    Covered Software is provided under this License on an “as is” basis, without
 *    warranty of any kind, either expressed, implied, or statutory, including,
 *    without limitation, warranties that the Covered Software is free of defects,
 *    merchantable, fit for a particular purpose or non-infringing. The entire
 *    risk as to the quality and performance of the Covered Software is with You.
 *    Should any Covered Software prove defective in any respect, You (not any
 *    Contributor) assume the cost of any necessary servicing, repair, or
 *    correction. This disclaimer of warranty constitutes an essential part of this
 *    License. No use of  any Covered Software is authorized under this License
 *    except under this disclaimer.
 *
 * 7. Limitation of Liability
 *
 *    Under no circumstances and under no legal theory, whether tort (including
 *    negligence), contract, or otherwise, shall any Contributor, or anyone who
 *    distributes Covered Software as permitted above, be liable to You for any
 *    direct, indirect, special, incidental, or consequential damages of any
 *    character including, without limitation, damages for lost profits, loss of
 *    goodwill, work stoppage, computer failure or malfunction, or any and all
 *    other commercial damages or losses, even if such party shall have been
 *    informed of the possibility of such damages. This limitation of liability
 *    shall not apply to liability for death or personal injury resulting from such
 *    party’s negligence to the extent applicable law prohibits such limitation.
 *    Some jurisdictions do not allow the exclusion or limitation of incidental or
 *    consequential damages, so this exclusion and limitation may not apply to You.
 *
 * 8. Litigation
 *
 *    Any litigation relating to this License may be brought only in the courts of
 *    a jurisdiction where the defendant maintains its principal place of business
 *    and such litigation shall be governed by laws of that jurisdiction, without
 *    reference to its conflict-of-law provisions. Nothing in this Section shall
 *    prevent a party’s ability to bring cross-claims or counter-claims.
 *
 * 9. Miscellaneous
 *
 *    This License represents the complete agreement concerning the subject matter
 *    hereof. If any provision of this License is held to be unenforceable, such
 *    provision shall be reformed only to the extent necessary to make it
 *    enforceable. Any law or regulation which provides that the language of a
 *    contract shall be construed against the drafter shall not be used to construe
 *    this License against a Contributor.
 *
 *
 * 10. Versions of the License
 *
 * 10.1. New Versions
 *
 *       Mozilla Foundation is the license steward. Except as provided in Section
 *       10.3, no one other than the license steward has the right to modify or
 *       publish new versions of this License. Each version will be given a
 *       distinguishing version number.
 *
 * 10.2. Effect of New Versions
 *
 *       You may distribute the Covered Software under the terms of the version of
 *       the License under which You originally received the Covered Software, or
 *       under the terms of any subsequent version published by the license
 *       steward.
 *
 * 10.3. Modified Versions
 *
 *       If you create software not governed by this License, and you want to
 *       create a new license for such software, you may create and use a modified
 *       version of this License if you rename the license and remove any
 *       references to the name of the license steward (except to note that such
 *       modified license differs from this License).
 *
 * 10.4. Distributing Source Code Form that is Incompatible With Secondary Licenses
 *       If You choose to distribute Source Code Form that is Incompatible With
 *       Secondary Licenses under the terms of this version of the License, the
 *       notice described in Exhibit B of this License must be attached.
 *
 * Exhibit A - Source Code Form License Notice
 *
 *       This Source Code Form is subject to the
 *       terms of the Mozilla Public License, v.
 *       2.0. If a copy of the MPL was not
 *       distributed with this file, You can
 *       obtain one at
 *       http://mozilla.org/MPL/2.0/.
 *
 * If it is not possible or desirable to put the notice in a particular file, then
 * You may include the notice in a location (such as a LICENSE file in a relevant
 * directory) where a recipient would be likely to look for such a notice.
 *
 * You may add additional accurate notices of copyright ownership.
 *
 * Exhibit B - “Incompatible With Secondary Licenses” Notice
 *
 *       This Source Code Form is “Incompatible
 *       With Secondary Licenses”, as defined by
 *       the Mozilla Public License, v. 2.0.
 */
package com.chiorichan.plugin;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.io.Reader;
import java.io.Writer;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.yaml.snakeyaml.Yaml;
import org.yaml.snakeyaml.constructor.SafeConstructor;

import com.chiorichan.command.Command;
import com.chiorichan.command.CommandExecutor;
import com.chiorichan.command.PluginCommand;
import com.chiorichan.permissions.Permissible;
import com.chiorichan.permissions.Permission;
import com.chiorichan.permissions.PermissionDefault;
import com.chiorichan.plugin.java.JavaPlugin;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;

/**
 * This type is the runtime-container for the information in the plugin.yml. All plugins must have a respective
 * plugin.yml. For plugins written in java using the standard plugin loader, this file must be in the root of the jar
 * file.
 * <p>
 * When Bukkit loads a plugin, it needs to know some basic information about it. It reads this information from a YAML
 * file, 'plugin.yml'. This file consists of a set of attributes, each defined on a new line and with no indentation.
 * <p>
 * Every (almost* every) method corresponds with a specific entry in the plugin.yml. These are the <b>required</b>
 * entries for every plugin.yml:
 * <ul>
 * <li>{@link #getName()} - <code>name</code>
 * <li>{@link #getVersion()} - <code>version</code>
 * <li>{@link #getMain()} - <code>main</code>
 * </ul>
 * <p>
 * Failing to include any of these items will throw an exception and cause the server to ignore your plugin.
 * <p>
 * This is a list of the possible yaml keys, with specific details included in the respective method documentations:
 * <table border=1>
 * <tr>
 * <th>Node</th>
 * <th>Method</th>
 * <th>Summary</th>
 * </tr>
 * <tr>
 * <td><code>name</code></td>
 * <td>{@link #getName()}</td>
 * <td>The unique name of plugin</td>
 * </tr>
 * <tr>
 * <td><code>version</code></td>
 * <td>{@link #getVersion()}</td>
 * <td>A plugin revision identifier</td>
 * </tr>
 * <tr>
 * <td><code>main</code></td>
 * <td>{@link #getMain()}</td>
 * <td>The plugin's initial class file</td>
 * </tr>
 * <tr>
 * <td><code>author</code><br>
 * <code>authors</code></td>
 * <td>{@link #getAuthors()}</td>
 * <td>The plugin contributors</td>
 * </tr>
 * <tr>
 * <td><code>description</code></td>
 * <td>{@link #getDescription()}</td>
 * <td>Human readable plugin summary</td>
 * </tr>
 * <tr>
 * <td><code>website</code></td>
 * <td>{@link #getWebsite()}</td>
 * <td>The URL to the plugin's site</td>
 * </tr>
 * <tr>
 * <td><code>prefix</code></td>
 * <td>{@link #getPrefix()}</td>
 * <td>The token to prefix plugin log entries</td>
 * </tr>
 * <tr>
 * <td><code>database</code></td>
 * <td>{@link #isDatabaseEnabled()}</td>
 * <td>Indicator to enable database support</td>
 * </tr>
 * <tr>
 * <td><code>load</code></td>
 * <td>{@link #getLoad()}</td>
 * <td>The phase of server-startup this plugin will load during</td>
 * </tr>
 * <tr>
 * <td><code>depend</code></td>
 * <td>{@link #getDepend()}</td>
 * <td>Other required plugins</td>
 * </tr>
 * <tr>
 * <td><code>softdepend</code></td>
 * <td>{@link #getSoftDepend()}</td>
 * <td>Other plugins that add functionality</td>
 * </tr>
 * <tr>
 * <td><code>loadbefore</code></td>
 * <td>{@link #getLoadBefore()}</td>
 * <td>The inverse softdepend</td>
 * </tr>
 * <tr>
 * <td><code>commands</code></td>
 * <td>{@link #getCommands()}</td>
 * <td>The commands the plugin will register</td>
 * </tr>
 * <tr>
 * <td><code>permissions</code></td>
 * <td>{@link #getPermissions()}</td>
 * <td>The permissions the plugin will register</td>
 * </tr>
 * <tr>
 * <td><code>default-permission</code></td>
 * <td>{@link #getPermissionDefault()}</td>
 * <td>The default {@link Permission#getDefault() default} permission state for defined {@link #getPermissions()
 * permissions} the plugin will register</td>
 * </tr>
 * </table>
 * <p>
 * A plugin.yml example:<blockquote>
 * 
 * <pre>
 * name: Inferno
 * version: 1.4.1
 * description: This plugin is so 31337. You can set yourself on fire.
 * # We could place every author in the authors list, but chose not to for illustrative purposes
 * # Also, having an author distinguishes that person as the project lead, and ensures their
 * # name is displayed first
 * author: CaptainInflamo
 * authors: [Cogito, verrier, EvilSeph]
 * website: http://www.curse.com/server-mods/minecraft/myplugin
 * 
 * main: com.captaininflamo.bukkit.inferno.Inferno
 * database: false
 * depend: [NewFire, FlameWire]
 * 
 * commands:
 *   flagrate:
 *     description: Set yourself on fire.
 *     aliases: [combust_me, combustMe]
 *     permission: inferno.flagrate
 *     usage: Syntax error! Simply type /&lt;command&gt; to ignite yourself.
 *   burningdeaths:
 *     description: List how many times you have died by fire.
 *     aliases: [burning_deaths, burningDeaths]
 *     permission: inferno.burningdeaths
 *     usage: |
 *       /&lt;command&gt; [player]
 *       Example: /&lt;command&gt; - see how many times you have burned to death
 *       Example: /&lt;command&gt; CaptainIce - see how many times CaptainIce has burned to death
 * 
 * permissions:
 *   inferno.*:
 *     description: Gives access to all Inferno commands
 *     children:
 *       inferno.flagrate: true
 *       inferno.burningdeaths: true
 *       inferno.burningdeaths.others: true
 *   inferno.flagrate:
 *     description: Allows you to ignite yourself
 *     default: true
 *   inferno.burningdeaths:
 *     description: Allows you to see how many times you have burned to death
 *     default: true
 *   inferno.burningdeaths.others:
 *     description: Allows you to see how many times others have burned to death
 *     default: op
 *     children:
 *       inferno.burningdeaths: true
 * </pre>
 * 
 * </blockquote>
 */
public class PluginDescriptionFile
{
	private static final Yaml yaml = new Yaml( new SafeConstructor() );
	private String name = null;
	private String main = null;
	private String classLoaderOf = null;
	private List<String> depend = null;
	private List<String> softDepend = null;
	private List<String> loadBefore = null;
	private String version = null;
	private Map<String, Map<String, Object>> commands = null;
	private String description = null;
	private List<String> authors = null;
	private String website = null;
	private String prefix = null;
	private boolean database = false;
	private PluginLoadOrder order = PluginLoadOrder.INITIALIZED;
	private List<Permission> permissions = null;
	private Map<?, ?> lazyPermissions = null;
	private PermissionDefault defaultPerm = PermissionDefault.OP;

	public PluginDescriptionFile(final File file) throws InvalidDescriptionException, FileNotFoundException
	{
		loadMap( asMap( yaml.load( new FileInputStream( file ) ) ) );
	}
	
	public PluginDescriptionFile(final InputStream stream) throws InvalidDescriptionException
	{
		loadMap( asMap( yaml.load( stream ) ) );
	}
	
	/**
	 * Loads a PluginDescriptionFile from the specified reader
	 * 
	 * @param reader
	 *           The reader
	 * @throws InvalidDescriptionException
	 *            If the PluginDescriptionFile is invalid
	 */
	public PluginDescriptionFile(final Reader reader) throws InvalidDescriptionException
	{
		loadMap( asMap( yaml.load( reader ) ) );
	}
	
	/**
	 * Creates a new PluginDescriptionFile with the given detailed
	 * 
	 * @param pluginName
	 *           Name of this plugin
	 * @param pluginVersion
	 *           Version of this plugin
	 * @param mainClass
	 *           Full location of the main class of this plugin
	 */
	public PluginDescriptionFile(final String pluginName, final String pluginVersion, final String mainClass)
	{
		name = pluginName;
		version = pluginVersion;
		main = mainClass;
	}
	
	/**
	 * Gives the name of the plugin. This name is a unique identifier for plugins.
	 * <ul>
	 * <li>Must consist of all alphanumeric characters, underscores, hyphon, and period (a-z,A-Z,0-9, _.-). Any other
	 * character will cause the plugin.yml to fail loading.
	 * <li>Used to determine the name of the plugin's data folder. Data folders are placed in the ./plugins/ directory by
	 * default, but this behavior should not be relied on. {@link Plugin#getDataFolder()} should be used to reference the
	 * data folder.
	 * <li>It is good practice to name your jar the same as this, for example 'MyPlugin.jar'.
	 * <li>Case sensitive.
	 * <li>The is the token referenced in {@link #getDepend()}, {@link #getSoftDepend()}, and {@link #getLoadBefore()}.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>name</code>.
	 * <p>
	 * Example:<blockquote>
	 * 
	 * <pre>
	 * name: MyPlugin
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the name of the plugin
	 */
	public String getName()
	{
		return name;
	}
	
	/**
	 * Gives the version of the plugin.
	 * <ul>
	 * <li>Version is an arbitrary string, however the most common format is MajorRelease.MinorRelease.Build (eg: 1.4.1).
	 * <li>Typically you will increment this every time you release a new feature or bug fix.
	 * <li>Displayed when a user types <code>/version PluginName</code>
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>version</code>.
	 * <p>
	 * Example:<blockquote>
	 * 
	 * <pre>
	 * version: 1.4.1
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the version of the plugin
	 */
	public String getVersion()
	{
		return version;
	}
	
	/**
	 * Gives the fully qualified name of the main class for a plugin. The format should follow the
	 * {@link ClassLoader#loadClass(String)} syntax to successfully be resolved at runtime. For most plugins, this is the
	 * class that extends {@link JavaPlugin}.
	 * <ul>
	 * <li>This must contain the full namespace including the class file itself.
	 * <li>If your namespace is <code>org.bukkit.plugin</code>, and your class file is called <code>MyPlugin</code> then
	 * this must be <code>org.bukkit.plugin.MyPlugin</code>
	 * <li>No plugin can use <code>org.bukkit.</code> as a base package for <b>any class</b>, including the main class.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>main</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * main: org.bukkit.plugin.MyPlugin
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the fully qualified main class for the plugin
	 */
	public String getMain()
	{
		return main;
	}
	
	/**
	 * Gives a human-friendly description of the functionality the plugin provides.
	 * <ul>
	 * <li>The description can have multiple lines.
	 * <li>Displayed when a user types <code>/version PluginName</code>
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>description</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * description: This plugin is so 31337. You can set yourself on fire.
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return description of this plugin, or null if not specified
	 */
	public String getDescription()
	{
		return description;
	}
	
	/**
	 * Gives the phase of server startup that the plugin should be loaded.
	 * <ul>
	 * <li>Possible values are in {@link PluginLoadOrder}.
	 * <li>Defaults to {@link PluginLoadOrder#POSTWORLD}.
	 * <li>Certain caveats apply to each phase.
	 * <li>When different, {@link #getDepend()}, {@link #getSoftDepend()}, and {@link #getLoadBefore()} become relative
	 * in order loaded per-phase. If a plugin loads at <code>STARTUP</code>, but a dependency loads at
	 * <code>POSTWORLD</code>, the dependency will not be loaded before the plugin is loaded.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>load</code>.
	 * <p>
	 * Example:<blockquote>
	 * 
	 * <pre>
	 * load: STARTUP
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the phase when the plugin should be loaded
	 */
	public PluginLoadOrder getLoad()
	{
		return order;
	}
	
	/**
	 * Gives the list of authors for the plugin.
	 * <ul>
	 * <li>Gives credit to the developer.
	 * <li>Used in some server error messages to provide helpful feedback on who to contact when an error occurs.
	 * <li>A bukkit.org forum handle or email address is recommended.
	 * <li>Is displayed when a user types <code>/version PluginName</code>
	 * <li><code>authors</code> must be in <a href="http://en.wikipedia.org/wiki/YAML#Lists">YAML list format</a>.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this has two entries, <code>author</code> and <code>authors</code>.
	 * <p>
	 * Single author example: <blockquote>
	 * 
	 * <pre>
	 * author: CaptainInflamo
	 * </pre>
	 * 
	 * </blockquote> Multiple author example: <blockquote>
	 * 
	 * <pre>
	 * authors: [Cogito, verrier, EvilSeph]
	 * </pre>
	 * 
	 * </blockquote> When both are specified, author will be the first entry in the list, so this example: <blockquote>
	 * 
	 * <pre>
	 * author: Grum
	 * authors:
	 * - feildmaster
	 * - amaranth
	 * </pre>
	 * 
	 * </blockquote> Is equivilant to this example: <blockquote>
	 * 
	 * <pre>authors: [Grum, feildmaster, aramanth]
	 * 
	 * <pre>
	 * </blockquote>
	 * 
	 * @return an immutable list of the plugin's authors
	 */
	public List<String> getAuthors()
	{
		return authors;
	}
	
	/**
	 * Gives the plugin's or plugin's author's website.
	 * <ul>
	 * <li>A link to the Curse page that includes documentation and downloads is highly recommended.
	 * <li>Displayed when a user types <code>/version PluginName</code>
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>website</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * website: http://www.curse.com/server-mods/minecraft/myplugin
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return description of this plugin, or null if not specified
	 */
	public String getWebsite()
	{
		return website;
	}
	
	/**
	 * Gives if the plugin uses a database.
	 * <ul>
	 * <li>Using a database is non-trivial.
	 * <li>Valid values include <code>true</code> and <code>false</code>
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>database</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * database: false
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return if this plugin requires a database
	 * @see Plugin#getDatabase()
	 */
	public boolean isDatabaseEnabled()
	{
		return database;
	}
	
	/**
	 * Gives a list of other plugins that the plugin requires.
	 * <ul>
	 * <li>Use the value in the {@link #getName()} of the target plugin to specify the dependency.
	 * <li>If any plugin listed here is not found, your plugin will fail to load at startup.
	 * <li>If multiple plugins list each other in <code>depend</code>, creating a network with no individual plugin does
	 * not list another plugin in the <a href=https://en.wikipedia.org/wiki/Circular_dependency>network</a>, all plugins
	 * in that network will fail.
	 * <li><code>depend</code> must be in must be in <a href="http://en.wikipedia.org/wiki/YAML#Lists">YAML list
	 * format</a>.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>depend</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * depend:
	 * - OnePlugin
	 * - AnotherPlugin
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return immutable list of the plugin's dependencies
	 */
	public List<String> getDepend()
	{
		return depend;
	}
	
	/**
	 * Gives a list of other plugins that the plugin requires for full functionality. The {@link PluginManager} will make
	 * best effort to treat all entries here as if they were a {@link #getDepend() dependency}, but will never fail
	 * because of one of these entries.
	 * <ul>
	 * <li>Use the value in the {@link #getName()} of the target plugin to specify the dependency.
	 * <li>When an unresolvable plugin is listed, it will be ignored and does not affect load order.
	 * <li>When a circular dependency occurs (a network of plugins depending or soft-dependending each other), it will
	 * arbitrarily choose a plugin that can be resolved when ignoring soft-dependencies.
	 * <li><code>softdepend</code> must be in <a href="http://en.wikipedia.org/wiki/YAML#Lists">YAML list format</a>.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>softdepend</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * softdepend: [OnePlugin, AnotherPlugin]
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return immutable list of the plugin's preferred dependencies
	 */
	public List<String> getSoftDepend()
	{
		return softDepend;
	}
	
	/**
	 * Gets the list of plugins that should consider this plugin a soft-dependency.
	 * <ul>
	 * <li>Use the value in the {@link #getName()} of the target plugin to specify the dependency.
	 * <li>The plugin should load before any other plugins listed here.
	 * <li>Specifying another plugin here is strictly equivalent to having the specified plugin's
	 * {@link #getSoftDepend()} include {@link #getName() this plugin}.
	 * <li><code>loadbefore</code> must be in <a href="http://en.wikipedia.org/wiki/YAML#Lists">YAML list format</a>.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>loadbefore</code>.
	 * <p>
	 * Example: <blockquote>
	 * 
	 * <pre>
	 * loadbefore:
	 * - OnePlugin
	 * - AnotherPlugin
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return immutable list of plugins that should consider this plugin a soft-dependency
	 */
	public List<String> getLoadBefore()
	{
		return loadBefore;
	}
	
	/**
	 * Gives the token to prefix plugin-specific logging messages with.
	 * <ul>
	 * <li>This includes all messages using {@link Plugin#getLogger()}.
	 * <li>If not specified, the server uses the plugin's {@link #getName() name}.
	 * <li>This should clearly indicate what plugin is being logged.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>prefix</code>.
	 * <p>
	 * Example:<blockquote>
	 * 
	 * <pre>
	 * prefix: ex-why-zee
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the prefixed logging token, or null if not specified
	 */
	public String getPrefix()
	{
		return prefix;
	}
	
	/**
	 * Gives the map of command-name to command-properties. Each entry in this map corresponds to a single command and
	 * the respective values are the properties of the command. Each property, <i>with the exception of aliases</i>, can
	 * be defined at runtime using methods in {@link PluginCommand} and are defined here only as a convenience.
	 * <table border=1>
	 * <tr>
	 * <th>Node</th>
	 * <th>Method</th>
	 * <th>Type</th>
	 * <th>Description</th>
	 * <th>Example</th>
	 * </tr>
	 * <tr>
	 * <td><code>description</code></td>
	 * <td>{@link PluginCommand#setDescription(String)}</td>
	 * <td>String</td>
	 * <td>A user-friendly description for a command. It is useful for documentation purposes as well as in-game help.</td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * description: Set yourself on fire
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>aliases</code></td>
	 * <td>{@link PluginCommand#setAliases(List)}</td>
	 * <td>String or <a href="http://en.wikipedia.org/wiki/YAML#Lists">List</a> of strings</td>
	 * <td>Alternative command names, with special usefulness for commands that are already registered. <i>Aliases are
	 * not effective when defined at runtime,</i> so the plugin description file is the only way to have them properly
	 * defined.</td>
	 * <td>Single alias format: <blockquote>
	 * 
	 * <pre>
	 * aliases: combust_me
	 * </pre>
	 * 
	 * </blockquote> or multiple alias format: <blockquote>
	 * 
	 * <pre>
	 * aliases: [combust_me, combustMe]
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>permission</code></td>
	 * <td>{@link PluginCommand#setPermission(String)}</td>
	 * <td>String</td>
	 * <td>The name of the {@link Permission} required to use the command. A user without the permission will receive the
	 * specified message (see {@linkplain PluginCommand#setPermissionMessage(String) below}), or a standard one if no
	 * specific message is defined. Without the permission node, no {@link PluginCommand#setExecutor(CommandExecutor)
	 * CommandExecutor} or {@link PluginCommand#setTabCompleter(TabCompleter) TabCompleter} will be called.</td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * permission: inferno.flagrate
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>permission-message</code></td>
	 * <td>{@link PluginCommand#setPermissionMessage(String)}</td>
	 * <td>String</td>
	 * <td>
	 * <ul>
	 * <li>Displayed to a player that attempts to use a command, but does not have the required permission. See
	 * {@link PluginCommand#getPermission() above}.
	 * <li>&lt;permission&gt; is a macro that is replaced with the permission node required to use the command.
	 * <li>Using empty quotes is a valid way to indicate nothing should be displayed to a player.
	 * </ul>
	 * </td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * permission-message: You do not have /&lt;permission&gt;
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>usage</code></td>
	 * <td>{@link PluginCommand#setUsage(String)}</td>
	 * <td>String</td>
	 * <td>This message is displayed to a player when the {@link PluginCommand#setExecutor(CommandExecutor)}
	 * {@linkplain CommandExecutor#onCommand(CommandSender,Command,String,String[]) returns false}. &lt;command&gt; is a
	 * macro that is replaced the command issued.</td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * usage: Syntax error! Perhaps you meant /&lt;command&gt; PlayerName?
	 * </pre>
	 * 
	 * </blockquote> It is worth noting that to use a colon in a yaml, like <code>`usage: Usage: /god [player]'</code>,
	 * you need to <a href="http://yaml.org/spec/current.html#id2503232">surround the message with double-quote</a>:
	 * <blockquote>
	 * 
	 * <pre>
	 * usage: "Usage: /god [player]"
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * </table>
	 * The commands are structured as a hiearchy of <a href="http://yaml.org/spec/current.html#id2502325">nested
	 * mappings</a>. The primary (top-level, no intendentation) node is `<code>commands</code>', while each individual
	 * command name is indented, indicating it maps to some value (in our case, the properties of the table above).
	 * <p>
	 * Here is an example bringing together the piecemeal examples above, as well as few more definitions:<blockquote>
	 * 
	 * <pre>
	 * commands:
	 *   flagrate:
	 *     description: Set yourself on fire.
	 *     aliases: [combust_me, combustMe]
	 *     permission: inferno.flagrate
	 *     permission-message: You do not have /&lt;permission&gt;
	 *     usage: Syntax error! Perhaps you meant /&lt;command&gt; PlayerName?
	 *   burningdeaths:
	 *     description: List how many times you have died by fire.
	 *     aliases:
	 *     - burning_deaths
	 *     - burningDeaths
	 *     permission: inferno.burningdeaths
	 *     usage: |
	 *       /&lt;command&gt; [player]
	 *       Example: /&lt;command&gt; - see how many times you have burned to death
	 *       Example: /&lt;command&gt; CaptainIce - see how many times CaptainIce has burned to death
	 *   # The next command has no description, aliases, etc. defined, but is still valid
	 *   # Having an empty declaration is useful for defining the description, permission, and messages from a configuration dynamically
	 *   apocalypse:
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the commands this plugin will register
	 */
	public Map<String, Map<String, Object>> getCommands()
	{
		return commands;
	}
	
	/**
	 * Gives the list of permissions the plugin will register at runtime, immediately proceding enabling. The format for
	 * defining permissions is a map from permission name to properties. To represent a map without any specific
	 * property, empty <a href="http://yaml.org/spec/current.html#id2502702">curly-braces</a> ( <code>&#123;&#125;</code>
	 * ) may be used (as a null value is not accepted, unlike the {@link #getCommands() commands} above).
	 * <p>
	 * A list of optional properties for permissions:
	 * <table border=1>
	 * <tr>
	 * <th>Node</th>
	 * <th>Description</th>
	 * <th>Example</th>
	 * </tr>
	 * <tr>
	 * <td><code>description</code></td>
	 * <td>Plaintext (user-friendly) description of what the permission is for.</td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * description: Allows you to set yourself on fire
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>default</code></td>
	 * <td>The default state for the permission, as defined by {@link Permission#getDefault()}. If not defined, it will
	 * be set to the value of {@link PluginDescriptionFile#getPermissionDefault()}.
	 * <p>
	 * For reference:
	 * <ul>
	 * <li><code>true</code> - Represents a positive assignment to {@link Permissible permissibles}.
	 * <li><code>false</code> - Represents no assignment to {@link Permissible permissibles}.
	 * <li><code>op</code> - Represents a positive assignment to {@link Permissible#isOp() operator permissibles}.
	 * <li><code>notop</code> - Represents a positive assignment to {@link Permissible#isOp() non-operator permissibiles}.
	 * </ul>
	 * </td>
	 * <td><blockquote>
	 * 
	 * <pre>
	 * default: true
	 * </pre>
	 * 
	 * </blockquote></td>
	 * </tr>
	 * <tr>
	 * <td><code>children</code></td>
	 * <td>Allows other permissions to be set as a {@linkplain Permission#getChildren() relation} to the parent
	 * permission. When a parent permissions is assigned, child permissions are respectively assigned as well.
	 * <ul>
	 * <li>When a parent permission is assigned negatively, child permissions are assigned based on an inversion of their
	 * association.
	 * <li>When a parent permission is assigned positively, child permissions are assigned based on their association.
	 * </ul>
	 * <p>
	 * Child permissions may be defined in a number of ways:
	 * <ul>
	 * <li>Children may be defined as a <a href="http://en.wikipedia.org/wiki/YAML#Lists">list</a> of names. Using a list
	 * will treat all children associated positively to their parent.
	 * <li>Children may be defined as a map. Each permission name maps to either a boolean (representing the
	 * association), or a nested permission definition (just as another permission). Using a nested definition treats the
	 * child as a positive association.
	 * <li>A nested permission definition must be a map of these same properties. To define a valid nested permission
	 * without defining any specific property, empty curly-braces ( <code>&#123;&#125;</code> ) must be used.
	 * <li>A nested permission may carry it's own nested permissions as children, as they may also have nested
	 * permissions, and so forth. There is no direct limit to how deep the permission tree is defined.
	 * </ul>
	 * </td>
	 * <td>As a list: <blockquote>
	 * 
	 * <pre>
	 * children: [inferno.flagrate, inferno.burningdeaths]
	 * </pre>
	 * 
	 * </blockquote> Or as a mapping: <blockquote>
	 * 
	 * <pre>
	 * children:
	 *  inferno.flagrate: true
	 *  inferno.burningdeaths: true
	 * </pre>
	 * 
	 * </blockquote> An additional example showing basic nested values can be seen <a
	 * href="doc-files/permissions-example_plugin.yml">here</a>.</td>
	 * </tr>
	 * </table>
	 * The permissions are structured as a hiearchy of <a href="http://yaml.org/spec/current.html#id2502325">nested
	 * mappings</a>. The primary (top-level, no intendentation) node is `<code>permissions</code>', while each individual
	 * permission name is indented, indicating it maps to some value (in our case, the properties of the table above).
	 * <p>
	 * Here is an example using some of the properties:<blockquote>
	 * 
	 * <pre>
	 * permissions:
	 *   inferno.*:
	 *     description: Gives access to all Inferno commands
	 *     children:
	 *       inferno.flagrate: true
	 *       inferno.burningdeaths: true
	 *   inferno.flagate:
	 *     description: Allows you to ignite yourself
	 *     default: true
	 *   inferno.burningdeaths:
	 *     description: Allows you to see how many times you have burned to death
	 *     default: true
	 * </pre>
	 * 
	 * </blockquote> Another example, with nested definitions, can be found <a
	 * href="doc-files/permissions-example_plugin.yml">here</a>.
	 */
	public List<Permission> getPermissions()
	{
		if ( permissions == null )
		{
			if ( lazyPermissions == null )
			{
				permissions = ImmutableList.<Permission> of();
			}
			else
			{
				permissions = ImmutableList.copyOf( Permission.loadPermissions( lazyPermissions, "Permission node '%s' in plugin description file for " + getFullName() + " is invalid", defaultPerm ) );
				lazyPermissions = null;
			}
		}
		return permissions;
	}
	
	/**
	 * Gives the default {@link Permission#getDefault() default} state of {@link #getPermissions() permissions}
	 * registered for the plugin.
	 * <ul>
	 * <li>If not specified, it will be {@link PermissionDefault#OP}.
	 * <li>It is matched using {@link PermissionDefault#getByName(String)}
	 * <li>It only affects permissions that do not define the <code>default</code> node.
	 * <li>It may be any value in {@link PermissionDefault}.
	 * </ul>
	 * <p>
	 * In the plugin.yml, this entry is named <code>default-permission</code>.
	 * <p>
	 * Example:<blockquote>
	 * 
	 * <pre>
	 * default-permission: NOT_OP
	 * </pre>
	 * 
	 * </blockquote>
	 * 
	 * @return the default value for the plugin's permissions
	 */
	public PermissionDefault getPermissionDefault()
	{
		return defaultPerm;
	}
	
	/**
	 * Returns the name of a plugin, including the version. This method is provided for convenience; it uses the
	 * {@link #getName()} and {@link #getVersion()} entries.
	 * 
	 * @return a descriptive name of the plugin and respective version
	 */
	public String getFullName()
	{
		return name + " v" + version;
	}
	
	public String getClassLoaderOf()
	{
		return classLoaderOf;
	}
	
	public void setDatabaseEnabled( boolean database )
	{
		this.database = database;
	}
	
	/**
	 * Saves this PluginDescriptionFile to the given writer
	 * 
	 * @param writer
	 *           Writer to output this file to
	 */
	public void save( Writer writer )
	{
		yaml.dump( saveMap(), writer );
	}
	
	private void loadMap( Map<?, ?> map ) throws InvalidDescriptionException
	{
		try
		{
			name = map.get( "name" ).toString();
			
			if ( !name.matches( "^[A-Za-z0-9 _.-]+$" ) )
			{
				throw new InvalidDescriptionException( "name '" + name + "' contains invalid characters." );
			}
		}
		catch ( NullPointerException ex )
		{
			throw new InvalidDescriptionException( ex, "name is not defined" );
		}
		catch ( ClassCastException ex )
		{
			throw new InvalidDescriptionException( ex, "name is of wrong type" );
		}
		
		try
		{
			version = map.get( "version" ).toString();
		}
		catch ( NullPointerException ex )
		{
			throw new InvalidDescriptionException( ex, "version is not defined" );
		}
		catch ( ClassCastException ex )
		{
			throw new InvalidDescriptionException( ex, "version is of wrong type" );
		}
		
		try
		{
			main = map.get( "main" ).toString();
			//if ( main.startsWith( "com.chiori." ) )
			//{
				//throw new InvalidDescriptionException( "main may not be within the org.bukkit namespace" );
			//}
			
			// TODO Renable this once I can take care of my plugins namespace
		}
		catch ( NullPointerException ex )
		{
			throw new InvalidDescriptionException( ex, "main is not defined" );
		}
		catch ( ClassCastException ex )
		{
			throw new InvalidDescriptionException( ex, "main is of wrong type" );
		}
		
		if ( map.get( "commands" ) != null )
		{
			ImmutableMap.Builder<String, Map<String, Object>> commandsBuilder = ImmutableMap.<String, Map<String, Object>> builder();
			try
			{
				for ( Map.Entry<?, ?> command : ( (Map<?, ?>) map.get( "commands" ) ).entrySet() )
				{
					ImmutableMap.Builder<String, Object> commandBuilder = ImmutableMap.<String, Object> builder();
					if ( command.getValue() != null )
					{
						for ( Map.Entry<?, ?> commandEntry : ( (Map<?, ?>) command.getValue() ).entrySet() )
						{
							if ( commandEntry.getValue() instanceof Iterable )
							{
								// This prevents internal alias list changes
								ImmutableList.Builder<Object> commandSubList = ImmutableList.<Object> builder();
								for ( Object commandSubListItem : (Iterable<?>) commandEntry.getValue() )
								{
									if ( commandSubListItem != null )
									{
										commandSubList.add( commandSubListItem );
									}
								}
								commandBuilder.put( commandEntry.getKey().toString(), commandSubList.build() );
							}
							else if ( commandEntry.getValue() != null )
							{
								commandBuilder.put( commandEntry.getKey().toString(), commandEntry.getValue() );
							}
						}
					}
					commandsBuilder.put( command.getKey().toString(), commandBuilder.build() );
				}
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "commands are of wrong type" );
			}
			commands = commandsBuilder.build();
		}
		
		if ( map.get( "class-loader-of" ) != null )
		{
			classLoaderOf = map.get( "class-loader-of" ).toString();
		}
		
		if ( map.get( "depend" ) != null )
		{
			ImmutableList.Builder<String> dependBuilder = ImmutableList.<String> builder();
			try
			{
				for ( Object dependency : (Iterable<?>) map.get( "depend" ) )
				{
					dependBuilder.add( dependency.toString() );
				}
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "depend is of wrong type" );
			}
			catch ( NullPointerException e )
			{
				throw new InvalidDescriptionException( e, "invalid dependency format" );
			}
			depend = dependBuilder.build();
		}
		
		if ( map.get( "softdepend" ) != null )
		{
			ImmutableList.Builder<String> softDependBuilder = ImmutableList.<String> builder();
			try
			{
				for ( Object dependency : (Iterable<?>) map.get( "softdepend" ) )
				{
					softDependBuilder.add( dependency.toString() );
				}
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "softdepend is of wrong type" );
			}
			catch ( NullPointerException ex )
			{
				throw new InvalidDescriptionException( ex, "invalid soft-dependency format" );
			}
			softDepend = softDependBuilder.build();
		}
		
		if ( map.get( "loadbefore" ) != null )
		{
			ImmutableList.Builder<String> loadBeforeBuilder = ImmutableList.<String> builder();
			try
			{
				for ( Object predependency : (Iterable<?>) map.get( "loadbefore" ) )
				{
					loadBeforeBuilder.add( predependency.toString() );
				}
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "loadbefore is of wrong type" );
			}
			catch ( NullPointerException ex )
			{
				throw new InvalidDescriptionException( ex, "invalid load-before format" );
			}
			loadBefore = loadBeforeBuilder.build();
		}
		
		if ( map.get( "database" ) != null )
		{
			try
			{
				database = (Boolean) map.get( "database" );
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "database is of wrong type" );
			}
		}
		
		if ( map.get( "website" ) != null )
		{
			website = map.get( "website" ).toString();
		}
		
		if ( map.get( "description" ) != null )
		{
			description = map.get( "description" ).toString();
		}
		
		if ( map.get( "load" ) != null )
		{
			try
			{
				order = PluginLoadOrder.valueOf( ( (String) map.get( "load" ) ).toUpperCase().replaceAll( "\\W", "" ) );
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "load is of wrong type" );
			}
			catch ( IllegalArgumentException ex )
			{
				throw new InvalidDescriptionException( ex, "load is not a valid choice" );
			}
		}
		
		if ( map.get( "authors" ) != null )
		{
			ImmutableList.Builder<String> authorsBuilder = ImmutableList.<String> builder();
			if ( map.get( "author" ) != null )
			{
				authorsBuilder.add( map.get( "author" ).toString() );
			}
			try
			{
				for ( Object o : (Iterable<?>) map.get( "authors" ) )
				{
					authorsBuilder.add( o.toString() );
				}
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "authors are of wrong type" );
			}
			catch ( NullPointerException ex )
			{
				throw new InvalidDescriptionException( ex, "authors are improperly defined" );
			}
			authors = authorsBuilder.build();
		}
		else if ( map.get( "author" ) != null )
		{
			authors = ImmutableList.of( map.get( "author" ).toString() );
		}
		else
		{
			authors = ImmutableList.<String> of();
		}
		
		if ( map.get( "default-permission" ) != null )
		{
			try
			{
				defaultPerm = PermissionDefault.getByName( map.get( "default-permission" ).toString() );
			}
			catch ( ClassCastException ex )
			{
				throw new InvalidDescriptionException( ex, "default-permission is of wrong type" );
			}
			catch ( IllegalArgumentException ex )
			{
				throw new InvalidDescriptionException( ex, "default-permission is not a valid choice" );
			}
		}
		
		try
		{
			lazyPermissions = (Map<?, ?>) map.get( "permissions" );
		}
		catch ( ClassCastException ex )
		{
			throw new InvalidDescriptionException( ex, "permissions are of the wrong type" );
		}
		
		if ( map.get( "prefix" ) != null )
		{
			prefix = map.get( "prefix" ).toString();
		}
	}
	
	private Map<String, Object> saveMap()
	{
		Map<String, Object> map = new HashMap<String, Object>();
		
		map.put( "name", name );
		map.put( "main", main );
		map.put( "version", version );
		map.put( "database", database );
		map.put( "order", order.toString() );
		map.put( "default-permission", defaultPerm.toString() );
		
		if ( commands != null )
		{
			map.put( "command", commands );
		}
		if ( depend != null )
		{
			map.put( "depend", depend );
		}
		if ( softDepend != null )
		{
			map.put( "softdepend", softDepend );
		}
		if ( website != null )
		{
			map.put( "website", website );
		}
		if ( description != null )
		{
			map.put( "description", description );
		}
		
		if ( authors.size() == 1 )
		{
			map.put( "author", authors.get( 0 ) );
		}
		else if ( authors.size() > 1 )
		{
			map.put( "authors", authors );
		}
		
		if ( classLoaderOf != null )
		{
			map.put( "class-loader-of", classLoaderOf );
		}
		
		if ( prefix != null )
		{
			map.put( "prefix", prefix );
		}
		
		return map;
	}
	
	private Map<?, ?> asMap( Object object ) throws InvalidDescriptionException
	{
		if ( object instanceof Map )
		{
			return (Map<?, ?>) object;
		}
		throw new InvalidDescriptionException( object + " is not properly structured." );
	}
}
